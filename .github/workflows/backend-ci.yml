name: Backend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Check syntax
        run: node --check src/server.js
  
  validate:
    name: Validate Backend Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check required files
        run: |
          cd backend
          for file in package.json Dockerfile docker-compose.yml; do
            if [ ! -f "$file" ]; then
              echo "❌ Required file $file not found"
              exit 1
            fi
            echo "✅ $file exists"
          done
      
      - name: Check source structure
        run: |
          cd backend
          for dir in src src/routes src/utils src/db src/middleware; do
            if [ ! -d "$dir" ]; then
              echo "❌ Required directory $dir not found"
              exit 1
            fi
            echo "✅ $dir exists"
          done
      
      - name: Validate package.json
        run: |
          cd backend
          cat package.json | python3 -m json.tool > /dev/null
          echo "✅ package.json is valid JSON"

  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        working-directory: ./backend
        run: |
          docker build -t gigis-backend-test .
          echo "✅ Docker image built successfully"
      
      - name: Test Docker image
        run: |
          docker images | grep gigis-backend-test
          echo "✅ Docker image verified"
