name: Extension CI

on:
  push:
    branches: [ main, develop, 'feature/**' ]
    paths:
      - '**.js'
      - 'manifest.json'
      - 'services/**'
      - 'overlay/**'
      - '!backend/**'
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Extension
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate manifest
        run: |
          if [ ! -f manifest.json ]; then
            echo "❌ manifest.json not found"
            exit 1
          fi
          echo "✅ manifest.json exists"
          cat manifest.json | python3 -m json.tool > /dev/null
          echo "✅ manifest.json is valid JSON"
      
      - name: Check required files
        run: |
          for file in background.js storage.js constants.js; do
            if [ ! -f "$file" ]; then
              echo "❌ Required file $file not found"
              exit 1
            fi
            echo "✅ $file exists"
          done
      
      - name: Check services
        run: |
          if [ ! -d services ]; then
            echo "❌ services directory not found"
            exit 1
          fi
          echo "✅ Services directory exists"
          ls -la services/

  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create build artifact
        run: |
          mkdir -p dist
          cp manifest.json dist/
          cp *.js dist/ 2>/dev/null || true
          cp -r services/ utils/ overlay/ icons/ dist/ 2>/dev/null || true
          echo "✅ Extension packaged successfully"
          ls -la dist/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: dist/
          retention-days: 30
